# Copyright 2025 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

load("@rules_foreign_cc//foreign_cc:defs.bzl", "cmake")

licenses(["notice"])  # Apache 2

package(default_visibility = ["//visibility:public"])

filegroup(
    name = "srcs",
    srcs = glob(["**"]),
)

# LLVM configuration for Linux x86_64 builds
# LLVM_BUILD_UTILS and LLVM_INCLUDE_UTILS are disabled to avoid mlgo-utils
# test suite errors (requires llvm-objcopy and yaml2obj tools that are disabled).
# Only X86 target is built to minimize library size.
cmake(
    name = "llvm_wamr_lib_linux_x86",
    cache_entries = {
        # Disable both: BUILD and INCLUDE, since some of the INCLUDE
        # targets build code instead of only generating build files.
        "CMAKE_CXX_FLAGS": "-Wno-unused-command-line-argument",
        "LLVM_BUILD_BENCHMARKS": "off",
        "LLVM_BUILD_DOCS": "off",
        "LLVM_BUILD_EXAMPLES": "off",
        "LLVM_BUILD_TESTS": "off",
        "LLVM_BUILD_TOOLS": "off",
        "LLVM_BUILD_UTILS": "off",
        "LLVM_ENABLE_IDE": "off",
        "LLVM_ENABLE_LIBEDIT": "off",
        "LLVM_ENABLE_LIBXML2": "off",
        "LLVM_ENABLE_TERMINFO": "off",
        "LLVM_ENABLE_ZLIB": "off",
        "LLVM_ENABLE_ZSTD": "off",
        "LLVM_INCLUDE_BENCHMARKS": "off",
        "LLVM_INCLUDE_DOCS": "off",
        "LLVM_INCLUDE_EXAMPLES": "off",
        "LLVM_INCLUDE_TESTS": "off",
        "LLVM_INCLUDE_TOOLS": "off",
        "LLVM_INCLUDE_UTILS": "off",
        "LLVM_TARGETS_TO_BUILD": "X86",
    },
    # `lld` works on Linux
    generate_args = [
        "-GNinja",
        "-DLLVM_USE_LINKER=lld",
    ],
    lib_source = ":srcs",
    out_data_dirs = [
        "libexec",
        "share",
    ],
    out_static_libs = [
        # How to get the library list:
        #  build LLVM with "-DLLVM_INCLUDE_TOOLS=ON"
        #  cd bin and run "./llvm-config --libnames"
        # X86-specific libraries only (no AArch64, no Windows-specific libs)
        "libLLVMX86Disassembler.a",
        "libLLVMX86AsmParser.a",
        "libLLVMX86CodeGen.a",
        "libLLVMX86Desc.a",
        "libLLVMX86Info.a",
        # Common LLVM libraries (architecture-independent)
        "libLLVMOrcJIT.a",
        "libLLVMMCJIT.a",
        "libLLVMJITLink.a",
        "libLLVMInterpreter.a",
        "libLLVMExecutionEngine.a",
        "libLLVMRuntimeDyld.a",
        "libLLVMOrcTargetProcess.a",
        "libLLVMOrcShared.a",
        "libLLVMDWP.a",
        "libLLVMSymbolize.a",
        "libLLVMDebugInfoPDB.a",
        "libLLVMDebugInfoGSYM.a",
        "libLLVMOption.a",
        "libLLVMObjectYAML.a",
        "libLLVMMCA.a",
        "libLLVMMCDisassembler.a",
        "libLLVMLTO.a",
        "libLLVMPasses.a",
        "libLLVMCFGuard.a",
        "libLLVMCoroutines.a",
        "libLLVMObjCARCOpts.a",
        "libLLVMipo.a",
        "libLLVMVectorize.a",
        "libLLVMLinker.a",
        "libLLVMInstrumentation.a",
        "libLLVMFrontendOpenMP.a",
        "libLLVMFrontendOpenACC.a",
        "libLLVMExtensions.a",
        "libLLVMDWARFLinker.a",
        "libLLVMGlobalISel.a",
        "libLLVMMIRParser.a",
        "libLLVMAsmPrinter.a",
        "libLLVMDebugInfoMSF.a",
        "libLLVMDebugInfoDWARF.a",
        "libLLVMSelectionDAG.a",
        "libLLVMCodeGen.a",
        "libLLVMIRReader.a",
        "libLLVMAsmParser.a",
        "libLLVMInterfaceStub.a",
        "libLLVMFileCheck.a",
        "libLLVMFuzzMutate.a",
        "libLLVMTarget.a",
        "libLLVMScalarOpts.a",
        "libLLVMInstCombine.a",
        "libLLVMAggressiveInstCombine.a",
        "libLLVMTransformUtils.a",
        "libLLVMBitWriter.a",
        "libLLVMAnalysis.a",
        "libLLVMProfileData.a",
        "libLLVMObject.a",
        "libLLVMTextAPI.a",
        "libLLVMMCParser.a",
        "libLLVMMC.a",
        "libLLVMDebugInfoCodeView.a",
        "libLLVMBitReader.a",
        "libLLVMCore.a",
        "libLLVMRemarks.a",
        "libLLVMBitstreamReader.a",
        "libLLVMBinaryFormat.a",
        "libLLVMTableGen.a",
        "libLLVMTargetParser.a",
        "libLLVMSupport.a",
        "libLLVMDemangle.a",
    ],
    working_directory = "llvm",
)

# LLVM configuration for Linux aarch64 builds
# Similar to Linux x86_64 but builds only AArch64 target.
cmake(
    name = "llvm_wamr_lib_linux_aarch64",
    cache_entries = {
        "CMAKE_CXX_FLAGS": "-Wno-unused-command-line-argument",
        "LLVM_BUILD_BENCHMARKS": "off",
        "LLVM_BUILD_DOCS": "off",
        "LLVM_BUILD_EXAMPLES": "off",
        "LLVM_BUILD_TESTS": "off",
        "LLVM_BUILD_TOOLS": "off",
        "LLVM_BUILD_UTILS": "off",
        "LLVM_ENABLE_IDE": "off",
        "LLVM_ENABLE_LIBEDIT": "off",
        "LLVM_ENABLE_LIBXML2": "off",
        "LLVM_ENABLE_TERMINFO": "off",
        "LLVM_ENABLE_ZLIB": "off",
        "LLVM_ENABLE_ZSTD": "off",
        "LLVM_INCLUDE_BENCHMARKS": "off",
        "LLVM_INCLUDE_DOCS": "off",
        "LLVM_INCLUDE_EXAMPLES": "off",
        "LLVM_INCLUDE_TESTS": "off",
        "LLVM_INCLUDE_TOOLS": "off",
        "LLVM_INCLUDE_UTILS": "off",
        "LLVM_TARGETS_TO_BUILD": "AArch64",
    },
    # `lld` works on Linux
    generate_args = [
        "-GNinja",
        "-DLLVM_USE_LINKER=lld",
    ],
    lib_source = ":srcs",
    out_data_dirs = [
        "libexec",
        "share",
    ],
    out_static_libs = [
        # AArch64-specific libraries only (no X86, no Windows-specific libs)
        "libLLVMAArch64Disassembler.a",
        "libLLVMAArch64AsmParser.a",
        "libLLVMAArch64CodeGen.a",
        "libLLVMAArch64Desc.a",
        "libLLVMAArch64Info.a",
        "libLLVMAArch64Utils.a",
        # Common LLVM libraries (architecture-independent)
        "libLLVMOrcJIT.a",
        "libLLVMMCJIT.a",
        "libLLVMJITLink.a",
        "libLLVMInterpreter.a",
        "libLLVMExecutionEngine.a",
        "libLLVMRuntimeDyld.a",
        "libLLVMOrcTargetProcess.a",
        "libLLVMOrcShared.a",
        "libLLVMDWP.a",
        "libLLVMSymbolize.a",
        "libLLVMDebugInfoPDB.a",
        "libLLVMDebugInfoGSYM.a",
        "libLLVMOption.a",
        "libLLVMObjectYAML.a",
        "libLLVMMCA.a",
        "libLLVMMCDisassembler.a",
        "libLLVMLTO.a",
        "libLLVMPasses.a",
        "libLLVMCFGuard.a",
        "libLLVMCoroutines.a",
        "libLLVMObjCARCOpts.a",
        "libLLVMipo.a",
        "libLLVMVectorize.a",
        "libLLVMLinker.a",
        "libLLVMInstrumentation.a",
        "libLLVMFrontendOpenMP.a",
        "libLLVMFrontendOpenACC.a",
        "libLLVMExtensions.a",
        "libLLVMDWARFLinker.a",
        "libLLVMGlobalISel.a",
        "libLLVMMIRParser.a",
        "libLLVMAsmPrinter.a",
        "libLLVMDebugInfoMSF.a",
        "libLLVMDebugInfoDWARF.a",
        "libLLVMSelectionDAG.a",
        "libLLVMCodeGen.a",
        "libLLVMIRReader.a",
        "libLLVMAsmParser.a",
        "libLLVMInterfaceStub.a",
        "libLLVMFileCheck.a",
        "libLLVMFuzzMutate.a",
        "libLLVMTarget.a",
        "libLLVMScalarOpts.a",
        "libLLVMInstCombine.a",
        "libLLVMAggressiveInstCombine.a",
        "libLLVMTransformUtils.a",
        "libLLVMBitWriter.a",
        "libLLVMAnalysis.a",
        "libLLVMProfileData.a",
        "libLLVMObject.a",
        "libLLVMTextAPI.a",
        "libLLVMMCParser.a",
        "libLLVMMC.a",
        "libLLVMDebugInfoCodeView.a",
        "libLLVMBitReader.a",
        "libLLVMCore.a",
        "libLLVMRemarks.a",
        "libLLVMBitstreamReader.a",
        "libLLVMBinaryFormat.a",
        "libLLVMTableGen.a",
        "libLLVMTargetParser.a",
        "libLLVMSupport.a",
        "libLLVMDemangle.a",
    ],
    working_directory = "llvm",
)

# LLVM configuration for macOS x86_64 builds
# LLVM_BUILD_UTILS and LLVM_INCLUDE_UTILS are disabled to avoid mlgo-utils
# test suite errors (requires llvm-objcopy and yaml2obj tools that are disabled).
# Only X86 target is built to minimize library size.
cmake(
    name = "llvm_wamr_lib_macos_x86",
    cache_entries = {
        # Disable both: BUILD and INCLUDE, since some of the INCLUDE
        # targets build code instead of only generating build files.
        "CMAKE_CXX_FLAGS": "-Wno-unused-command-line-argument",
        "CMAKE_OSX_ARCHITECTURES": "x86_64",
        "LLVM_BUILD_BENCHMARKS": "off",
        "LLVM_BUILD_DOCS": "off",
        "LLVM_BUILD_EXAMPLES": "off",
        "LLVM_BUILD_TESTS": "off",
        "LLVM_BUILD_TOOLS": "off",
        "LLVM_BUILD_UTILS": "off",
        "LLVM_ENABLE_IDE": "off",
        "LLVM_ENABLE_LIBEDIT": "off",
        "LLVM_ENABLE_LIBXML2": "off",
        "LLVM_ENABLE_TERMINFO": "off",
        "LLVM_ENABLE_ZLIB": "off",
        "LLVM_ENABLE_ZSTD": "off",
        "LLVM_INCLUDE_BENCHMARKS": "off",
        "LLVM_INCLUDE_DOCS": "off",
        "LLVM_INCLUDE_EXAMPLES": "off",
        "LLVM_INCLUDE_TESTS": "off",
        "LLVM_INCLUDE_TOOLS": "off",
        "LLVM_INCLUDE_UTILS": "off",
        "LLVM_TARGETS_TO_BUILD": "X86",
    },
    # `lld` doesn't work on macOS
    generate_args = ["-GNinja"],
    lib_source = ":srcs",
    out_data_dirs = [
        "libexec",
        "share",
    ],
    out_static_libs = [
        # How to get the library list:
        #  build LLVM with "-DLLVM_INCLUDE_TOOLS=ON"
        #  cd bin and run "./llvm-config --libnames"
        # X86-specific libraries only (no AArch64, no Windows-specific libs)
        "libLLVMX86Disassembler.a",
        "libLLVMX86AsmParser.a",
        "libLLVMX86CodeGen.a",
        "libLLVMX86Desc.a",
        "libLLVMX86Info.a",
        # Common LLVM libraries (architecture-independent)
        "libLLVMOrcJIT.a",
        "libLLVMMCJIT.a",
        "libLLVMJITLink.a",
        "libLLVMInterpreter.a",
        "libLLVMExecutionEngine.a",
        "libLLVMRuntimeDyld.a",
        "libLLVMOrcTargetProcess.a",
        "libLLVMOrcShared.a",
        "libLLVMDWP.a",
        "libLLVMSymbolize.a",
        "libLLVMDebugInfoPDB.a",
        "libLLVMDebugInfoGSYM.a",
        "libLLVMOption.a",
        "libLLVMObjectYAML.a",
        "libLLVMMCA.a",
        "libLLVMMCDisassembler.a",
        "libLLVMLTO.a",
        "libLLVMPasses.a",
        "libLLVMCFGuard.a",
        "libLLVMCoroutines.a",
        "libLLVMObjCARCOpts.a",
        "libLLVMipo.a",
        "libLLVMVectorize.a",
        "libLLVMLinker.a",
        "libLLVMInstrumentation.a",
        "libLLVMFrontendOpenMP.a",
        "libLLVMFrontendOpenACC.a",
        "libLLVMExtensions.a",
        "libLLVMDWARFLinker.a",
        "libLLVMGlobalISel.a",
        "libLLVMMIRParser.a",
        "libLLVMAsmPrinter.a",
        "libLLVMDebugInfoMSF.a",
        "libLLVMDebugInfoDWARF.a",
        "libLLVMSelectionDAG.a",
        "libLLVMCodeGen.a",
        "libLLVMIRReader.a",
        "libLLVMAsmParser.a",
        "libLLVMInterfaceStub.a",
        "libLLVMFileCheck.a",
        "libLLVMFuzzMutate.a",
        "libLLVMTarget.a",
        "libLLVMScalarOpts.a",
        "libLLVMInstCombine.a",
        "libLLVMAggressiveInstCombine.a",
        "libLLVMTransformUtils.a",
        "libLLVMBitWriter.a",
        "libLLVMAnalysis.a",
        "libLLVMProfileData.a",
        "libLLVMObject.a",
        "libLLVMTextAPI.a",
        "libLLVMMCParser.a",
        "libLLVMMC.a",
        "libLLVMDebugInfoCodeView.a",
        "libLLVMBitReader.a",
        "libLLVMCore.a",
        "libLLVMRemarks.a",
        "libLLVMBitstreamReader.a",
        "libLLVMBinaryFormat.a",
        "libLLVMTableGen.a",
        "libLLVMTargetParser.a",
        "libLLVMSupport.a",
        "libLLVMDemangle.a",
    ],
    working_directory = "llvm",
)

# LLVM configuration for macOS aarch64 builds
# Similar to macOS x86_64 but builds only AArch64 target.
cmake(
    name = "llvm_wamr_lib_macos_aarch64",
    cache_entries = {
        "CMAKE_CXX_FLAGS": "-Wno-unused-command-line-argument",
        "CMAKE_OSX_ARCHITECTURES": "arm64",
        "LLVM_BUILD_BENCHMARKS": "off",
        "LLVM_BUILD_DOCS": "off",
        "LLVM_BUILD_EXAMPLES": "off",
        "LLVM_BUILD_TESTS": "off",
        "LLVM_BUILD_TOOLS": "off",
        "LLVM_BUILD_UTILS": "off",
        "LLVM_ENABLE_IDE": "off",
        "LLVM_ENABLE_LIBEDIT": "off",
        "LLVM_ENABLE_LIBXML2": "off",
        "LLVM_ENABLE_TERMINFO": "off",
        "LLVM_ENABLE_ZLIB": "off",
        "LLVM_ENABLE_ZSTD": "off",
        "LLVM_INCLUDE_BENCHMARKS": "off",
        "LLVM_INCLUDE_DOCS": "off",
        "LLVM_INCLUDE_EXAMPLES": "off",
        "LLVM_INCLUDE_TESTS": "off",
        "LLVM_INCLUDE_TOOLS": "off",
        "LLVM_INCLUDE_UTILS": "off",
        "LLVM_TARGETS_TO_BUILD": "AArch64",
    },
    # `lld` doesn't work on macOS
    generate_args = ["-GNinja"],
    lib_source = ":srcs",
    out_data_dirs = [
        "libexec",
        "share",
    ],
    out_static_libs = [
        # AArch64-specific libraries only (no X86, no Windows-specific libs)
        "libLLVMAArch64Disassembler.a",
        "libLLVMAArch64AsmParser.a",
        "libLLVMAArch64CodeGen.a",
        "libLLVMAArch64Desc.a",
        "libLLVMAArch64Info.a",
        "libLLVMAArch64Utils.a",
        # Common LLVM libraries (architecture-independent)
        "libLLVMOrcJIT.a",
        "libLLVMMCJIT.a",
        "libLLVMJITLink.a",
        "libLLVMInterpreter.a",
        "libLLVMExecutionEngine.a",
        "libLLVMRuntimeDyld.a",
        "libLLVMOrcTargetProcess.a",
        "libLLVMOrcShared.a",
        "libLLVMDWP.a",
        "libLLVMSymbolize.a",
        "libLLVMDebugInfoPDB.a",
        "libLLVMDebugInfoGSYM.a",
        "libLLVMOption.a",
        "libLLVMObjectYAML.a",
        "libLLVMMCA.a",
        "libLLVMMCDisassembler.a",
        "libLLVMLTO.a",
        "libLLVMPasses.a",
        "libLLVMCFGuard.a",
        "libLLVMCoroutines.a",
        "libLLVMObjCARCOpts.a",
        "libLLVMipo.a",
        "libLLVMVectorize.a",
        "libLLVMLinker.a",
        "libLLVMInstrumentation.a",
        "libLLVMFrontendOpenMP.a",
        "libLLVMFrontendOpenACC.a",
        "libLLVMExtensions.a",
        "libLLVMDWARFLinker.a",
        "libLLVMGlobalISel.a",
        "libLLVMMIRParser.a",
        "libLLVMAsmPrinter.a",
        "libLLVMDebugInfoMSF.a",
        "libLLVMDebugInfoDWARF.a",
        "libLLVMSelectionDAG.a",
        "libLLVMCodeGen.a",
        "libLLVMIRReader.a",
        "libLLVMAsmParser.a",
        "libLLVMInterfaceStub.a",
        "libLLVMFileCheck.a",
        "libLLVMFuzzMutate.a",
        "libLLVMTarget.a",
        "libLLVMScalarOpts.a",
        "libLLVMInstCombine.a",
        "libLLVMAggressiveInstCombine.a",
        "libLLVMTransformUtils.a",
        "libLLVMBitWriter.a",
        "libLLVMAnalysis.a",
        "libLLVMProfileData.a",
        "libLLVMObject.a",
        "libLLVMTextAPI.a",
        "libLLVMMCParser.a",
        "libLLVMMC.a",
        "libLLVMDebugInfoCodeView.a",
        "libLLVMBitReader.a",
        "libLLVMCore.a",
        "libLLVMRemarks.a",
        "libLLVMBitstreamReader.a",
        "libLLVMBinaryFormat.a",
        "libLLVMTableGen.a",
        "libLLVMTargetParser.a",
        "libLLVMSupport.a",
        "libLLVMDemangle.a",
    ],
    working_directory = "llvm",
)

# Platform-specific config settings to enable proper select() in alias rule
config_setting(
    name = "linux_x86_64",
    constraint_values = [
        "@platforms//os:linux",
        "@platforms//cpu:x86_64",
    ],
)

config_setting(
    name = "linux_aarch64",
    constraint_values = [
        "@platforms//os:linux",
        "@platforms//cpu:aarch64",
    ],
)

config_setting(
    name = "macos_x86_64",
    constraint_values = [
        "@platforms//os:macos",
        "@platforms//cpu:x86_64",
    ],
)

config_setting(
    name = "macos_aarch64",
    constraint_values = [
        "@platforms//os:macos",
        "@platforms//cpu:aarch64",
    ],
)

# Platform and architecture-aware alias that selects the appropriate LLVM configuration
alias(
    name = "llvm_wamr_lib",
    actual = select({
        ":linux_x86_64": ":llvm_wamr_lib_linux_x86",
        ":linux_aarch64": ":llvm_wamr_lib_linux_aarch64",
        ":macos_x86_64": ":llvm_wamr_lib_macos_x86",
        ":macos_aarch64": ":llvm_wamr_lib_macos_aarch64",
        # Default to x86_64 Linux for other architectures
        "//conditions:default": ":llvm_wamr_lib_linux_x86",
    }),
)
